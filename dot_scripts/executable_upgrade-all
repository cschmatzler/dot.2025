#!/usr/bin/env bash

set -euo pipefail

echo "ğŸš€ Starting system upgrade..."

echo "ğŸ“¦ Upgrading mise tools..."
if command -v mise &> /dev/null; then
    mise upgrade --bump
    
    # Add updated mise config to chezmoi and commit
    if command -v chezmoi &> /dev/null; then
        echo "ğŸ“ Adding mise config changes to chezmoi..."
        chezmoi add ~/.config/mise/config.toml
        
        echo "ğŸ’¾ Committing mise config updates..."
        CHEZMOI_SOURCE_DIR=$(chezmoi source-path)
        (cd "$CHEZMOI_SOURCE_DIR" && git add dot_config/mise/config.toml && git commit -m "Update mise tool versions

ğŸ¤– Auto-updated by upgrade-all script") || echo "â„¹ï¸  No changes to commit for mise config"
    fi
    
    echo "âœ… mise tools upgraded"
else
    echo "âš ï¸  mise not found, skipping..."
fi

echo "ğŸº Upgrading brew packages..."
if command -v brew &> /dev/null; then
    brew update
    brew upgrade
    
    # Upgrade HEAD/nightly packages
    echo "ğŸŒ™ Upgrading HEAD/nightly packages..."
    brew upgrade --fetch-HEAD
    
    echo "ğŸ§¹ Cleaning up brew..."
    brew cleanup
    echo "âœ… brew packages upgraded"
else
    echo "âš ï¸  brew not found, skipping..."
fi

echo "ğŸ”Œ Upgrading neovim plugins..."
if command -v nvim &> /dev/null; then
    # Using Lazy.nvim's headless sync command
    nvim --headless "+Lazy! sync" +qa
    echo "âœ… neovim plugins upgraded"
else
    echo "âš ï¸  neovim not found, skipping..."
fi

echo "ğŸ‰ All upgrades completed!"