#!/usr/bin/env nu

print "ğŸš€ Starting system upgrade..."

print "ğŸ“¦ Upgrading mise tools..."
if (which mise | is-not-empty) {
    mise upgrade --bump

    if (which chezmoi | is-not-empty) {
        print "ğŸ“ Adding mise config changes to chezmoi..."
        chezmoi add ~/.config/mise/config.toml

        print "ğŸ’¾ Committing mise config updates..."
        let chezmoi_source_dir = (chezmoi source-path | str trim)
        
        try {
            cd $chezmoi_source_dir
            git add dot_config/mise/config.toml
            git commit -m "Update mise tool versions

ğŸ¤– Auto-updated by upgrade-all script"
        } catch {
            print "â„¹ï¸  No changes to commit for mise config"
        }
    }

    print "âœ… mise tools upgraded"
} else {
    print "âš ï¸  mise not found, skipping..."
}

print "ğŸº Upgrading brew packages..."
if (which brew | is-not-empty) {
    brew update
    brew upgrade

    print "ğŸŒ™ Upgrading HEAD/nightly packages..."
    brew upgrade --fetch-HEAD

    print "ğŸ§¹ Cleaning up brew..."
    brew cleanup
    print "âœ… brew packages upgraded"
} else {
    print "âš ï¸  brew not found, skipping..."
}

print "ğŸ”Œ Upgrading neovim plugins..."
if (which nvim | is-not-empty) {
    nvim --headless "+Lazy! sync" +qa
    print "âœ… neovim plugins upgraded"
} else {
    print "âš ï¸  neovim not found, skipping..."
}

print "ğŸ‰ All upgrades completed!"